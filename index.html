<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .maincontainer {
            display: flex;
            height: 100vh;
        }

        .leftcontiner {
            width: 400px;
            background-color: white;
        }

        #map {
            flex: 1;
        }
    </style>
</head>

<body>
    <div class="maincontainer">
        <div class="leftcontiner">
            <div class="searchfield">
                <input type="search" class="inputsearch">
            </div>
            <div class="filter">
                <label for="radius">Distance</label>
                <input type="range" min="1" max="100" value="100" id="radius"
                    placeholder="Enter city, zip or address..">
                <span id="radius-value">100 miles</span>
                <button>Reset</button>
            </div>
            <div class="locationlist"></div>
        </div>
        <div id="map"></div>
    </div>

    <script>
        
        mapboxgl.accessToken = 'pk.eyJ1Ijoic3lhbGtoYW4iLCJhIjoiY20xYzY0a3MxMjJpcjJrczhreHI4YzhhMSJ9.QUd9e3ryFtDyVDKfTP4qIA';

var center = [-93.747236, 32.455793];
let locations = [];
var radiusRange =100;
var markerList = [];
const radiusInput = document.getElementById('radius');
        const radiusValue = document.getElementById('radius-value');

        radiusInput.addEventListener('input', (e) => {
            radiusRange = e.target.value;
            console.log(radiusRange);
            radiusValue.textContent = `${radiusRange} miles`;
            filterLocations();
        });

//Displaying map
const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: center,
            zoom: 12
        });

        //displaying marker on given location
        const el = document.createElement('div');
        el.innerHTML = `
  <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
    <path fill="#FF0000" d="M16 0C10.477 0 6 4.477 6 10c0 6.273 10 22 10 22s10-15.727 10-22c0-5.523-4.477-10-10-10zm0 16a6 6 0 1 1 0-12 6 6 0 0 1 0 12z"/>
  </svg>
`;
        new mapboxgl.Marker(el)
            .setLngLat(center)
            .addTo(map);

        //range function
       


         // Array to store the loaded locations

        // Fetch the locations from the JSON file
        fetch('locations.json')
            .then(response => response.json())
            .then(data => {
                locations = data; // Store the data from the JSON file
                filterLocations(); // Filter and display locations on the map after loading data
            })
            .catch(error => console.error('Error loading JSON data:', error));
        

        function filterLocations() {

           console.log(markerList.length);
           if (markerList.length >0) {

            markerList.forEach(marker => marker.remove());
            markerList = []; // Reset the markers array
            }
    
            // Filter locations within the radius
            locations.forEach(location => {
                const distance = calculateDistance(center, location.coordinates);
                // console.log("distance is: ",distance);
                // console.log("radius is : ", radiusRange);
                if (distance <= radiusRange) {
                    // If the location is within the radius, add it to the map
                    const marker = new mapboxgl.Marker()
                        .setLngLat(location.coordinates)
                        .setPopup(new mapboxgl.Popup().setHTML(`<strong>${location["Retail Accounts"]}</strong><br>${location["Address"]}, ${location["City"]}, ${location["State"]}`))
                        .addTo(map);
                        markerList.push(marker);
                }
            });
            console.log(markerList.length);
        }

        function calculateDistance(coord1, coord2) {
            const R = 3958.8; // Radius of the Earth in miles
            const lat1 = coord1[1] * Math.PI / 180; // Convert latitude to radians
            const lon1 = coord1[0] * Math.PI / 180; // Convert longitude to radians
            const lat2 = coord2[1] * Math.PI / 180;
            const lon2 = coord2[0] * Math.PI / 180;

            const dlat = lat2 - lat1;
            const dlon = lon2 - lon1;

            const a = Math.sin(dlat / 2) * Math.sin(dlat / 2) +
                Math.cos(lat1) * Math.cos(lat2) * Math.sin(dlon / 2) * Math.sin(dlon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c; // Distance in miles

            return distance;
        }





    </script>
</body>

</html>